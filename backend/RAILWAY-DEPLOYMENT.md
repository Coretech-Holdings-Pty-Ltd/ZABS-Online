# Railway Deployment Guide

## Overview

This guide will help you deploy the ZABS-Online backend to Railway.

## Prerequisites

- Railway account with access to the project
- PostgreSQL database provisioned on Railway
- Redis instance provisioned on Railway (optional but recommended)

## Required Environment Variables

### Essential Variables

```bash
# Database
DATABASE_URL=postgresql://...  # Auto-generated by Railway Postgres

# Security (Generate secure random strings)
JWT_SECRET=your-secure-jwt-secret
COOKIE_SECRET=your-secure-cookie-secret

# CORS Configuration
ADMIN_CORS=https://your-admin-domain.com,https://your-other-admin-domain.com
STORE_CORS=https://your-storefront-domain.com
AUTH_CORS=https://your-admin-domain.com

# Backend URL (Optional - Railway auto-detects this)
# RAILWAY_PUBLIC_DOMAIN is automatically provided by Railway
# BACKEND_PUBLIC_URL=https://your-backend-domain.railway.app
```

### Optional Variables

#### Redis (Recommended for Production)

```bash
REDIS_URL=redis://...  # Auto-generated by Railway Redis
```

#### File Storage (Choose One)

**Option 1: Local Storage (Default)**
No configuration needed - files stored in container (not recommended for production)

**Option 2: S3-Compatible Storage (Recommended)**

```bash
S3_ENDPOINT=https://your-project.supabase.co/storage/v1/s3
S3_BUCKET=your-bucket-name
S3_REGION=auto
S3_ACCESS_KEY_ID=your-access-key-id
S3_SECRET_ACCESS_KEY=your-secret-access-key
```

#### Email Notifications (Choose One)

**Option 1: Resend**

```bash
RESEND_API_KEY=re_...
RESEND_FROM_EMAIL=noreply@yourdomain.com
```

**Option 2: SendGrid**

```bash
SENDGRID_API_KEY=SG...
SENDGRID_FROM_EMAIL=noreply@yourdomain.com
```

#### Payment Gateway

```bash
STRIPE_API_KEY=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

#### Search (Optional)

```bash
MEILISEARCH_HOST=https://your-meilisearch-host.com
MEILISEARCH_ADMIN_KEY=your-admin-key
```

## Deployment Steps

1. **Push your code to GitHub** (if not already done)

   ```bash
   git add .
   git commit -m "Add health endpoint and Railway configuration"
   git push origin main
   ```

2. **Configure Environment Variables in Railway**

   - Go to your Railway project dashboard
   - Select your backend service
   - Navigate to "Variables" tab
   - Add all required environment variables listed above

3. **Add PostgreSQL Database** (if not already added)

   - Click "New" → "Database" → "Add PostgreSQL"
   - Railway will automatically inject `DATABASE_URL`

4. **Add Redis** (optional but recommended)

   - Click "New" → "Database" → "Add Redis"
   - Railway will automatically inject `REDIS_URL`

5. **Configure Health Check**

   - The health check is automatically configured to use `/health`
   - Timeout is set to 300 seconds to allow for initialization

6. **Deploy**
   - Railway will automatically deploy when you push to your connected branch
   - Monitor the build and deploy logs for any errors

## Troubleshooting

### Health Check Failing

**Symptom:** Deploy fails with "service unavailable" health check errors

**Solutions:**

1. **Check Deploy Logs**

   ```
   Railway Dashboard → Your Service → Deploy Logs
   ```

   Look for:

   - Database connection errors
   - Missing environment variables
   - Application startup errors

2. **Verify Required Environment Variables**

   - `DATABASE_URL` - Must be set
   - `JWT_SECRET` - Must be set
   - `COOKIE_SECRET` - Must be set

3. **Check Database Connection**

   - Ensure PostgreSQL service is running
   - Verify `DATABASE_URL` is correct
   - Check if database accepts SSL connections (required for Railway)

4. **Increase Health Check Timeout**

   - First deployment may take longer due to database migrations
   - The default timeout is 300 seconds (5 minutes)

5. **Check Application Logs**
   ```bash
   # In Railway dashboard, go to:
   Service → Deploy Logs → View full logs
   ```

### Database Migration Issues

If you see migration errors:

1. **Initial Setup**

   - The `init-backend` command runs automatically on first start
   - This runs migrations and seeds required data
   - First deployment may take 2-3 minutes

2. **Manual Migration** (if needed)
   - You can run migrations manually using Railway CLI:
   ```bash
   railway run pnpm ib
   ```

### Missing Dependencies

If build fails with missing dependencies:

1. **Clear Build Cache**

   - Railway Dashboard → Service → Settings → Clear Build Cache
   - Trigger new deployment

2. **Verify Package Manager**
   - Ensure `package.json` has `"packageManager": "pnpm@9.10.0"`
   - Ensure `.nvmrc` specifies Node version `22.11.0`

## Environment-Specific Configuration

### Production Recommendations

1. **Enable Redis** - Required for proper workflow engine and event bus
2. **Use S3-compatible storage** - Container storage is ephemeral
3. **Set up email notifications** - Required for order confirmations
4. **Configure Stripe** - Required for payments
5. **Set proper CORS origins** - Restrict to your actual domains
6. **Use strong secrets** - Generate cryptographically secure random strings

### Development vs Production

The application detects the environment based on `NODE_ENV`:

- Railway automatically sets `NODE_ENV=production`
- Local development uses `NODE_ENV=development`

## Post-Deployment

After successful deployment:

1. **Access Admin Dashboard**

   ```
   https://your-backend-domain.railway.app/app
   ```

2. **Create Admin User** (First time only)

   - Set `MEDUSA_ADMIN_EMAIL` and `MEDUSA_ADMIN_PASSWORD` before first deployment
   - Or create admin via API/database

3. **Test Health Endpoint**

   ```
   https://your-backend-domain.railway.app/health
   ```

   Should return:

   ```json
   {
     "status": "ok",
     "message": "Service is healthy",
     "timestamp": "2025-10-23T...",
     "uptime": 123.456
   }
   ```

4. **Connect Storefront**
   - Update storefront `NEXT_PUBLIC_MEDUSA_BACKEND_URL` to your Railway backend URL
   - Update backend `STORE_CORS` to include your storefront domain

## Monitoring

### Health Status

- Railway automatically monitors the `/health` endpoint
- Service will restart if health checks fail repeatedly

### Logs

- View real-time logs in Railway dashboard
- Deploy Logs: Build and startup logs
- Application Logs: Runtime logs

### Metrics

- Railway provides basic metrics (CPU, Memory, Network)
- Consider setting up additional monitoring (e.g., Sentry, LogRocket)

## Support

If you encounter issues:

1. Check the deploy logs in Railway dashboard
2. Review the troubleshooting section above
3. Ensure all required environment variables are set
4. Verify database and Redis are running
5. Check application logs for specific error messages

## Additional Resources

- [Railway Documentation](https://docs.railway.app/)
- [Medusa Documentation](https://docs.medusajs.com/)
- [Railway Environment Variables](https://docs.railway.app/develop/variables)
